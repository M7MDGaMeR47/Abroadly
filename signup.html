<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abroadly | Sign Up</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="signup.css">
</head>

<body>
    <div class="auth-layout">
        <div class="auth-left">
            <div class="gradient-ribbon"></div>

            <header class="header">
                <a href="landingpage.html" class="logo">
                    <i data-lucide="globe" class="logo-icon"></i>
                    <h2>Abroadly</h2>
                </a>
            </header>

            <div class="signup-wrapper">
                <main class="signup-container">

                    <!-- Step Navigation (Mentor Only) -->
                    <div class="progress-bar hidden" id="mentorProgress">
                        <div class="step active" data-step="1">1</div>
                        <div class="step-line"></div>
                        <div class="step" data-step="2">2</div>
                        <div class="step-line"></div>
                        <div class="step" data-step="3">3</div>
                        <div class="step-line"></div>
                        <div class="step" data-step="4">4</div>
                    </div>

                    <div id="step-role" class="step-content active">
                        <h1 class="title" id="title-role">Join <span>Abroadly</span></h1>
                        <p class="subtitle" id="sub-role">Choose your path to get started.</p>

                        <div class="role-selector">
                            <label class="role-card" tabindex="0">
                                <input type="radio" name="role" value="student" checked
                                    onchange="selectRole('student')">
                                <div class="role-card-content">
                                    <div class="role-icon-wrapper student-icon">
                                        <i data-lucide="graduation-cap"></i>
                                    </div>
                                    <h3 id="role-student-title">Student</h3>
                                    <p id="role-student-desc">I want to study abroad and need guidance.</p>
                                </div>
                            </label>

                            <label class="role-card" tabindex="0">
                                <input type="radio" name="role" value="mentor" onchange="selectRole('mentor')">
                                <div class="role-card-content">
                                    <div class="role-icon-wrapper mentor-icon">
                                        <i data-lucide="award"></i>
                                    </div>
                                    <h3 id="role-mentor-title">Mentor</h3>
                                    <p id="role-mentor-desc">I am studying abroad and want to guide others.</p>
                                </div>
                            </label>
                        </div>

                        <button type="button" class="btn btn-submit mt-6" onclick="nextStep()"
                            id="btn-continue">Continue</button>
                    </div>

                    <!-- STEP 1: Personal Info -->
                    <div id="step-personal" class="step-content">
                        <button type="button" class="back-btn" onclick="prevStep()">
                            <i data-lucide="arrow-left" class="rtl-flip"></i> <span id="btn-back-1">Back</span>
                        </button>
                        <h1 class="title text-left" id="title-personal">Create Profile</h1>
                        <p class="subtitle text-left mb-6" id="sub-personal">Tell us a bit about yourself.</p>

                        <form class="signup-form" id="form-personal" onsubmit="event.preventDefault(); nextStep();">
                            <div class="form-group">
                                <label for="name" id="lbl-name">Full Name</label>
                                <div class="input-wrapper">
                                    <i data-lucide="user" class="input-icon left-icon"></i>
                                    <input type="text" id="name" placeholder="Yassine B." required minlength="2">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="email" id="lbl-email">Email Address</label>
                                <div class="input-wrapper">
                                    <i data-lucide="mail" class="input-icon left-icon"></i>
                                    <input type="email" id="email" placeholder="yassine@example.dz" required>
                                </div>
                                <span class="inline-error" id="err-email">Invalid email format</span>
                            </div>

                            <div class="form-group">
                                <label for="phone" id="lbl-phone">Phone Number (Optional)</label>
                                <div class="input-wrapper">
                                    <i data-lucide="phone" class="input-icon left-icon"></i>
                                    <input type="tel" id="phone" placeholder="+213 661 23 45 67">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="password" id="lbl-password">Password</label>
                                <div class="input-wrapper">
                                    <i data-lucide="lock" class="input-icon left-icon"></i>
                                    <input type="password" id="password" placeholder="Min 12 chars or a phrase" required
                                        oninput="checkStrength()">
                                    <i data-lucide="eye" class="input-icon right-icon"
                                        onclick="togglePass('password')"></i>
                                </div>
                                <div class="pwd-strength" id="pwd-meter">
                                    <div></div>
                                    <div></div>
                                    <div></div>
                                    <div></div>
                                </div>
                                <span class="inline-error" id="err-password">Too weak — use 12 chars or a phrase</span>
                            </div>

                            <!-- Student Specific -->
                            <div id="student-extra" class="mt-4">
                                <div class="form-group">
                                    <label for="study_level" id="lbl-level">Current Study Level</label>
                                    <select id="study_level" class="custom-select">
                                        <option value="" disabled selected>Select level</option>
                                        <option value="hs">Highschool (BAC)</option>
                                        <option value="bsc">Bachelor</option>
                                        <option value="msc">Master</option>
                                    </select>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-submit mt-2" id="btn-next-personal">Continue</button>
                        </form>
                    </div>

                    <!-- STEP 2: Mentor Professional Info -->
                    <div id="step-professional" class="step-content">
                        <button type="button" class="back-btn" onclick="prevStep()">
                            <i data-lucide="arrow-left" class="rtl-flip"></i> <span id="btn-back-2">Back</span>
                        </button>
                        <h1 class="title text-left" id="title-prof">Academic Info</h1>
                        <p class="subtitle text-left mb-6" id="sub-prof">Details about your current studies abroad.</p>

                        <form class="signup-form" id="form-prof" onsubmit="event.preventDefault(); nextStep();">
                            <div class="form-group">
                                <label for="institution" id="lbl-inst">University / Institution</label>
                                <div class="input-wrapper">
                                    <i data-lucide="building" class="input-icon left-icon"></i>
                                    <input type="text" id="institution" placeholder="e.g. TUM Munich" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="years" id="lbl-years">Years Abroad</label>
                                <div class="input-wrapper">
                                    <i data-lucide="calendar" class="input-icon left-icon"></i>
                                    <input type="number" id="years" min="1" max="10" placeholder="1" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="bio" id="lbl-bio">Short Bio (Max 1000 chars)</label>
                                <textarea id="bio" rows="4" placeholder="I study CS in Germany..." maxlength="1000"
                                    class="custom-textarea" required></textarea>
                            </div>

                            <button type="submit" class="btn btn-submit mt-2" id="btn-next-prof">Continue to
                                Verification</button>
                        </form>
                    </div>

                    <!-- STEP 3: Mentor Document Upload -->
                    <div id="step-docs" class="step-content">
                        <button type="button" class="back-btn" onclick="prevStep()">
                            <i data-lucide="arrow-left" class="rtl-flip"></i> <span id="btn-back-3">Back</span>
                        </button>
                        <h1 class="title text-left" id="title-docs">Verify Identity</h1>
                        <p class="subtitle text-left mb-6" id="sub-docs">Upload Student ID or Visa. Max 8MB (JPG, PNG,
                            PDF).</p>

                        <div class="upload-area" id="drop-zone" onclick="document.getElementById('docs').click()">
                            <i data-lucide="upload-cloud" class="upload-icon"></i>
                            <p id="lbl-upload-text">Click to upload or drag & drop</p>
                            <span class="upload-hint">National ID, Passport, or Student Card</span>
                            <input type="file" id="docs" class="hidden" accept=".jpg,.png,.pdf" multiple
                                onchange="handleFiles(this.files)">
                        </div>

                        <div id="file-list" class="file-list mt-4"></div>
                        <span class="inline-error mt-2" id="err-file">File too large — max 8MB</span>

                        <div class="info-alert mt-4">
                            <i data-lucide="shield-check"></i>
                            <span id="txt-secure">Your documents are encrypted and only used for verification.</span>
                        </div>

                        <button type="button" class="btn btn-submit mt-6" onclick="submitSignup()"
                            id="btn-submit-mentor">Submit
                            Application</button>
                    </div>

                    <!-- STEP: Success / Verify Email -->
                    <div id="step-success" class="step-content text-center">
                        <div class="success-icon-wrapper mb-6 mx-auto">
                            <i data-lucide="mail-check" class="w-10 h-10 text-green-400"></i>
                        </div>
                        <h1 class="title" id="title-success">Check your email</h1>
                        <p class="subtitle" id="sub-success">We sent a verification link. Please click it to activate
                            your
                            account.</p>

                        <div id="mentor-pending-msg" class="hidden mentor-pending-box p-6 rounded-xl mt-4 mb-6 text-sm">
                            <div class="flex flex-col items-center text-center gap-3">
                                <i data-lucide="clock" class="text-accent w-10 h-10"></i>
                                <p id="txt-pending" class="text-center w-full text-base mt-2">Your documents are under
                                    review. We'll get back to you within 48h.</p>
                            </div>
                        </div>

                        <a href="https://mail.google.com" target="_blank" class="btn btn-submit mt-6"
                            style="text-decoration: none;">
                            Open Email Inbox <i data-lucide="external-link" style="width: 18px; margin-left: 4px;"></i>
                        </a>
                        <button type="button" class="btn btn-social mt-4" id="btn-resend">Resend Email</button>
                        <a href="login.html" class="forgot-password block mt-6" id="link-login">Back to Login</a>
                    </div>

                    <p class="signup-prompt mt-6" id="login-prompt">
                        Already have an account? <a href="login.html" id="link-signin">Sign In</a>
                    </p>
                </main>
            </div>
        </div>

        <div class="auth-right">
            <img src="https://images.unsplash.com/photo-1523240795612-9a054b0db644?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80"
                alt="Students" class="auth-bg">
            <div class="auth-overlay"></div>
            <div class="auth-content-right">
                <h2>Start Your Journey Abroad</h2>
                <p class="info-text">Connect with verified mentors who have real experience in international education
                    and employment.</p>

                <div class="auth-feature">
                    <div class="auth-feature-icon"><i data-lucide="check-circle"></i></div>
                    <div class="auth-feature-text">
                        <h4>Verified Mentors</h4>
                        <p>All mentors are verified with real international experience.</p>
                    </div>
                </div>

                <div class="auth-feature">
                    <div class="auth-feature-icon"><i data-lucide="book-open"></i></div>
                    <div class="auth-feature-text">
                        <h4>Personalized Guidance</h4>
                        <p>Get structured support tailored to your goals.</p>
                    </div>
                </div>

                <div class="auth-feature">
                    <div class="auth-feature-icon"><i data-lucide="users"></i></div>
                    <div class="auth-feature-text">
                        <h4>Trusted Community</h4>
                        <p>Join thousands of Algerian students achieving their dreams.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        lucide.createIcons();

        let currentStep = 0; // 0 = role, 1 = personal, 2 = prof, 3 = docs, 4 = success
        let chosenRole = 'student';
        let userEmail = '';
        let userName = '';
        let userPassword = '';

        // --- Flow Logic ---
        const steps = ['step-role', 'step-personal', 'step-professional', 'step-docs', 'step-success'];

        function selectRole(role) {
            chosenRole = role;
        }

        function updateView() {
            // Hide all steps
            steps.forEach(s => document.getElementById(s).classList.remove('active'));
            document.getElementById(steps[currentStep]).classList.add('active');

            // Hide/show extra info
            if (currentStep === 1) {
                document.getElementById('student-extra').style.display = chosenRole === 'student' ? 'block' : 'none';
            }
            if (currentStep === 4) {
                document.getElementById('login-prompt').style.display = 'none';
                if (chosenRole === 'mentor') document.getElementById('mentor-pending-msg').classList.remove('hidden');
            }

            // Progress bar
            const pb = document.getElementById('mentorProgress');
            if (chosenRole === 'mentor' && currentStep > 0 && currentStep < 4) {
                pb.classList.remove('hidden');
                document.querySelectorAll('.step').forEach(el => {
                    const stepNum = parseInt(el.getAttribute('data-step'));
                    if (stepNum <= currentStep) el.classList.add('active');
                    else el.classList.remove('active');
                });
            } else {
                pb.classList.add('hidden');
            }
        }

        function nextStep() {
            if (currentStep === 0) { currentStep = 1; }
            else if (currentStep === 1) {
                const email = document.getElementById('email').value;
                if (!email.includes('@')) {
                    document.getElementById('err-email').style.display = 'block';
                    return;
                }

                // Store data for email
                userEmail = email;
                userName = document.getElementById('name').value;
                userPassword = document.getElementById('password').value;

                document.getElementById('err-email').style.display = 'none';

                if (chosenRole === 'mentor') {
                    currentStep = 2;
                } else {
                    submitSignup('btn-next-personal'); // Trigger email automatically for students
                }
            }
            else if (currentStep === 2) { currentStep = 3; }
            updateView();
        }

        function prevStep() {
            if (currentStep === 1) currentStep = 0;
            else if (currentStep === 2) currentStep = 1;
            else if (currentStep === 3) currentStep = 2;
            updateView();
        }

        async function submitSignup(btnId = 'btn-submit-mentor') {
            const btnSubmit = document.getElementById(btnId);
            if (btnSubmit) { btnSubmit.innerText = "Processing..."; btnSubmit.disabled = true; }

            try {
                const response = await fetch('http://localhost:3000/api/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: userEmail,
                        name: userName,
                        password: userPassword,
                        role: chosenRole
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    if (btnSubmit) { btnSubmit.innerText = chosenRole === 'mentor' ? "Submit Application" : "Continue"; btnSubmit.disabled = false; }
                    document.getElementById('err-email').innerText = data.error || 'Signup failed';
                    document.getElementById('err-email').style.display = 'block';
                    currentStep = 1; // force back to email form if failed
                    updateView();
                    return;
                }

                currentStep = 4;
                updateView();

            } catch (err) {
                if (btnSubmit) { btnSubmit.innerText = chosenRole === 'mentor' ? "Submit Application" : "Continue"; btnSubmit.disabled = false; }
                alert('Service is offline. Start the backend server.');
            }
        }

        async function resendEmail() {
            const btn = document.getElementById('btn-resend');
            btn.innerText = "Sending...";
            btn.disabled = true;

            try {
                const response = await fetch('http://localhost:3000/api/send-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: userEmail || 'test@example.com',
                        name: userName || 'Student',
                        role: chosenRole
                    })
                });

                if (response.ok) {
                    btn.innerText = "Email Sent!";
                    setTimeout(() => {
                        btn.innerText = "Resend Email";
                        btn.disabled = false;
                    }, 3000);
                } else {
                    btn.innerText = "Failed. Try Again.";
                    btn.disabled = false;
                }
            } catch (err) {
                console.error('Email service offline.');
                btn.innerText = "Service Offline";
                setTimeout(() => {
                    btn.innerText = "Resend Email";
                    btn.disabled = false;
                }, 3000);
            }
        }

        document.getElementById('btn-resend').addEventListener('click', resendEmail);

        function togglePass(id) {
            const input = document.getElementById(id);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // --- Password Strength ---
        function checkStrength() {
            const pass = document.getElementById('password').value;
            const divs = document.querySelectorAll('#pwd-meter div');
            divs.forEach(d => d.className = '');

            let score = 0;
            if (pass.length > 5) score++;
            if (pass.length >= 12) score++;
            if (/[A-Z]/.test(pass)) score++;
            if (/[0-9]/.test(pass) || /[^A-Za-z0-9]/.test(pass)) score++;

            for (let i = 0; i < score; i++) {
                if (score <= 1) divs[i].className = 'weak';
                else if (score === 2) divs[i].className = 'medium';
                else divs[i].className = 'strong';
            }

            document.getElementById('err-password').style.display = (pass.length > 0 && score < 2) ? 'block' : 'none';
        }

        // --- File Upload ---
        function handleFiles(files) {
            const list = document.getElementById('file-list');
            list.innerHTML = '';
            document.getElementById('err-file').style.display = 'none';

            Array.from(files).forEach(file => {
                if (file.size > 8 * 1024 * 1024) {
                    document.getElementById('err-file').style.display = 'block';
                    return;
                }
                const div = document.createElement('div');
                div.className = 'file-item';
                div.innerHTML = `<i data-lucide="file-check" class="w-4 h-4 text-green-400"></i> <span class="text-sm truncate">${file.name}</span>`;
                list.appendChild(div);
            });
            lucide.createIcons();
        }
    </script>
</body>

</html>